(()=>{var e={};e.id=4239,e.ids=[4239],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33159:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},58879:(e,t,i)=>{"use strict";i.r(t),i.d(t,{patchFetch:()=>b,routeModule:()=>v,serverHooks:()=>y,workAsyncStorage:()=>O,workUnitAsyncStorage:()=>E});var n={};i.r(n),i.d(n,{GET:()=>_,PUT:()=>f});var r=i(2179),a=i(20540),o=i(57395),s=i(26064),d=i(24739),p=i(72482);!function(){var e=Error("Cannot find module '@opennextjs/cloudflare'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '@/lib/session'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '@/types/billing'");throw e.code="MODULE_NOT_FOUND",e}();let u=["Admin","Receptionist","Billing Staff","Patient"],c=["Admin","Receptionist","Billing Staff"];function l(e){let t=e.split("/"),i=parseInt(t[t.length-1],10);return isNaN(i)?null:i}async function _(e){let t=await (0,d.cookies)(),i=await (0,s.Nd)(t,Object(function(){var e=Error("Cannot find module '@/lib/session'");throw e.code="MODULE_NOT_FOUND",e}())),n=l(new URL(e.url).pathname);if(!i.user||!u.includes(i.user.roleName))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});if(null===n)return new Response(JSON.stringify({error:"Invalid Invoice ID"}),{status:400,headers:{"Content-Type":"application/json"}});try{let{env:e}=await Object(function(){var e=Error("Cannot find module '@opennextjs/cloudflare'");throw e.code="MODULE_NOT_FOUND",e}())(),{DB:t}=e,r=await t.prepare(`SELECT 
                i.*, 
                p.first_name as patient_first_name, p.last_name as patient_last_name;
             FROM Invoices i;
             JOIN Patients p ON i.patient_id = p.patient_id;
             WHERE i.invoice_id = ?`).bind(n).first();if(!r)return new Response(JSON.stringify({error:"Invoice not found"}),{status:404,headers:{"Content-Type":"application/json"}});if("Patient"===i.user.roleName){let e=await t.prepare("SELECT patient_id FROM Patients WHERE user_id = ? AND is_active = TRUE").bind(i.user.userId).first();if(!e||e.patient_id!==r.patient_id)return new Response(JSON.stringify({error:"Forbidden: You can only view your own invoices"}),{status:403,headers:{"Content-Type":"application/json"}})}let a=await t.prepare(`SELECT ii.*, bi.item_name as billable_item_name, bi.item_type as billable_item_type;
             FROM InvoiceItems ii 
             JOIN BillableItems bi ON ii.billable_item_id = bi.item_id;
             WHERE ii.invoice_id = ? ORDER BY ii.invoice_item_id`).bind(n).all(),o=await t.prepare("SELECT * FROM Payments WHERE invoice_id = ? ORDER BY payment_date DESC").bind(n).all(),s={invoice_id:r.invoice_id,invoice_number:r.invoice_number,patient_id:r.patient_id,appointment_id:r.appointment_id,admission_id:r.admission_id,invoice_date:r.invoice_date,due_date:r.due_date,total_amount:r.total_amount,paid_amount:r.paid_amount,discount_amount:r.discount_amount,tax_amount:r.tax_amount,status:r.status,notes:r.notes,created_by_user_id:r.created_by_user_id,created_at:r.created_at,updated_at:r.updated_at,patient:{patient_id:r.patient_id,first_name:r.patient_first_name,last_name:r.patient_last_name},items:a.results?.map(e=>({invoice_item_id:e.invoice_item_id,invoice_id:e.invoice_id,billable_item_id:e.billable_item_id,batch_id:e.batch_id,description:e.description,quantity:e.quantity,unit_price:e.unit_price,discount_amount:e.discount_amount,tax_amount:e.tax_amount,total_amount:e.total_amount,created_at:e.created_at,billable_item:{item_id:e.billable_item_id,item_name:e.billable_item_name,item_type:e.billable_item_type}}))||[],payments:o.results||[]};return new Response(JSON.stringify(s),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error(`Get invoice ${n} details error:`,e),new Response(JSON.stringify({error:"Internal Server Error",details:e instanceof Error?e.message:"An unexpected error occurred"}),{status:500,headers:{"Content-Type":"application/json"}})}}let m=p.z.object({due_date:p.z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional().nullable(),status:p.z.nativeEnum(Object(function(){var e=Error("Cannot find module '@/types/billing'");throw e.code="MODULE_NOT_FOUND",e}())).optional(),notes:p.z.string().optional().nullable()});async function f(e){let t=await (0,d.cookies)(),i=await (0,s.Nd)(t,Object(function(){var e=Error("Cannot find module '@/lib/session'");throw e.code="MODULE_NOT_FOUND",e}())),n=l(new URL(e.url).pathname);if(!i.user||!c.includes(i.user.roleName))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});if(null===n)return new Response(JSON.stringify({error:"Invalid Invoice ID"}),{status:400,headers:{"Content-Type":"application/json"}});try{let t=await e.json(),i=m.safeParse(t);if(!i.success)return new Response(JSON.stringify({error:"Invalid input",details:i.error.errors}),{status:400,headers:{"Content-Type":"application/json"}});let r=i.data;if(0===Object.keys(r).length)return new Response(JSON.stringify({message:"No update data provided"}),{status:200,headers:{"Content-Type":"application/json"}});let{env:a}=await Object(function(){var e=Error("Cannot find module '@opennextjs/cloudflare'");throw e.code="MODULE_NOT_FOUND",e}())(),{DB:o}=a;if(!await o.prepare("SELECT invoice_id, status FROM Invoices WHERE invoice_id = ?").bind(n).first())return new Response(JSON.stringify({error:"Invoice not found"}),{status:404,headers:{"Content-Type":"application/json"}});let s="UPDATE Invoices SET updated_at = CURRENT_TIMESTAMP",d=[];Object.entries(r).forEach(([e,t])=>{void 0!==t&&(s+=`, ${e} = ?`,d.push(t))}),s+=" WHERE invoice_id = ?",d.push(n);let p=await o.prepare(s).bind(...d).run();if(!p.success)throw console.error("Failed to update invoice:",p),Error("Failed to update invoice");return new Response(JSON.stringify({message:"Invoice updated successfully"}),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error(`Update invoice ${n} error:`,e),new Response(JSON.stringify({error:"Internal Server Error",details:e instanceof Error?e.message:"An unexpected error occurred"}),{status:500,headers:{"Content-Type":"application/json"}})}}let v=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/invoices/[invoiceId]/route",pathname:"/api/invoices/[invoiceId]",filename:"route",bundlePath:"app/api/invoices/[invoiceId]/route"},resolvedPagePath:"/workspace/Hospital-Management-System/src/app/api/invoices/[invoiceId]/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:O,workUnitAsyncStorage:E,serverHooks:y}=v;function b(){return(0,o.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:E})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73327:()=>{},77598:e=>{"use strict";e.exports=require("node:crypto")}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),n=t.X(0,[7395,2482,4388,1295],()=>i(58879));module.exports=n})();