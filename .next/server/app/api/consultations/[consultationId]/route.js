(()=>{var t={};t.id=2839,t.ids=[2839],t.modules={3295:t=>{"use strict";t.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:t=>{"use strict";t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:t=>{"use strict";t.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33159:()=>{},44870:t=>{"use strict";t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:t=>{"use strict";t.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73327:()=>{},74152:(t,e,r)=>{"use strict";r.r(e),r.d(e,{patchFetch:()=>g,routeModule:()=>w,serverHooks:()=>N,workAsyncStorage:()=>O,workUnitAsyncStorage:()=>E});var n={};r.r(n),r.d(n,{GET:()=>_,PUT:()=>m});var o=r(2179),s=r(20540),i=r(57395),a=r(26064),u=r(24739),l=r(72482);!function(){var t=Error("Cannot find module '@opennextjs/cloudflare'");throw t.code="MODULE_NOT_FOUND",t}(),function(){var t=Error("Cannot find module '@/lib/session'");throw t.code="MODULE_NOT_FOUND",t}();let d=["Admin","Doctor","Nurse"],c=["Doctor"];function p(t){let e=t.split("/"),r=parseInt(e[e.length-1],10);return isNaN(r)?null:r}async function _(t){let e=await (0,u.cookies)(),r=await (0,a.Nd)(e,Object(function(){var t=Error("Cannot find module '@/lib/session'");throw t.code="MODULE_NOT_FOUND",t}())),n=p(new URL(t.url).pathname);if(!r.user||!d.includes(r.user.roleName))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401});if(null===n)return new Response(JSON.stringify({error:"Invalid Consultation ID"}),{status:400});try{let t=(await Object(function(){var t=Error("Cannot find module '@opennextjs/cloudflare'");throw t.code="MODULE_NOT_FOUND",t}())()).env.DB;if(!t)throw Error("Database binding not found in Cloudflare environment.");let e=await t.prepare(`SELECT;
                c.*,
                p.first_name as patient_first_name, p.last_name as patient_last_name,
                u.full_name as doctor_full_name;
             FROM Consultations c;
             JOIN Patients p ON c.patient_id = p.patient_id;
             JOIN Doctors d ON c.doctor_id = d.doctor_id;
             JOIN Users u ON d.user_id = u.user_id;
             WHERE c.consultation_id = ?`).bind(n).first();if(!e)return new Response(JSON.stringify({error:"Consultation not found"}),{status:404});if("Doctor"===r.user.roleName){let n=await t.prepare("SELECT doctor_id FROM Doctors WHERE user_id = ?").bind(r.user.userId).first();if(!n||e.doctor_id!==n.doctor_id)return new Response(JSON.stringify({error:"Forbidden: Doctors can only view their own consultations"}),{status:403})}let o={consultation_id:e.consultation_id,patient_id:e.patient_id,doctor_id:e.doctor_id,opd_visit_id:e.opd_visit_id,admission_id:e.admission_id,consultation_datetime:e.consultation_datetime,chief_complaint:e.chief_complaint,history_of_present_illness:e.history_of_present_illness,physical_examination:e.physical_examination,diagnosis:e.diagnosis,treatment_plan:e.treatment_plan,follow_up_instructions:e.follow_up_instructions,notes:e.notes,created_at:e.created_at,updated_at:e.updated_at,patient:{patient_id:e.patient_id,first_name:e.patient_first_name,last_name:e.patient_last_name},doctor:{doctor_id:e.doctor_id,user:{fullName:e.doctor_full_name}}};return new Response(JSON.stringify(o),{status:200})}catch(t){return console.error(`Get consultation ${n} details error:`,t),new Response(JSON.stringify({error:"Internal Server Error",details:t instanceof Error?t.message:"An unexpected error occurred"}),{status:500})}}let f=l.z.object({chief_complaint:l.z.string().optional().nullable(),history_of_present_illness:l.z.string().optional().nullable(),physical_examination:l.z.string().optional().nullable(),diagnosis:l.z.string().optional().nullable(),treatment_plan:l.z.string().optional().nullable(),follow_up_instructions:l.z.string().optional().nullable(),notes:l.z.string().optional().nullable()});async function m(t){let e=await (0,u.cookies)(),r=await (0,a.Nd)(e,Object(function(){var t=Error("Cannot find module '@/lib/session'");throw t.code="MODULE_NOT_FOUND",t}())),n=p(new URL(t.url).pathname);if(!r.user||!c.includes(r.user.roleName))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401});if(null===n)return new Response(JSON.stringify({error:"Invalid Consultation ID"}),{status:400});try{let e=await t.json(),o=f.safeParse(e);if(!o.success)return new Response(JSON.stringify({error:"Invalid input",details:o.error.errors}),{status:400});let s=o.data;if(0===Object.keys(s).length)return new Response(JSON.stringify({message:"No update data provided"}),{status:200});let i=(await Object(function(){var t=Error("Cannot find module '@opennextjs/cloudflare'");throw t.code="MODULE_NOT_FOUND",t}())()).env.DB;if(!i)throw Error("Database binding not found in Cloudflare environment.");let a=await i.prepare("SELECT doctor_id FROM Doctors WHERE user_id = ?").bind(r.user.userId).first();if(!a)return new Response(JSON.stringify({error:"Doctor profile not found for the current user"}),{status:404});let u=await i.prepare("SELECT consultation_id, doctor_id FROM Consultations WHERE consultation_id = ?").bind(n).first();if(!u)return new Response(JSON.stringify({error:"Consultation not found"}),{status:404});if(u.doctor_id!==a.doctor_id)return new Response(JSON.stringify({error:"Forbidden: Doctors can only update their own consultations"}),{status:403});let l="UPDATE Consultations SET updated_at = CURRENT_TIMESTAMP",d=[];Object.entries(s).forEach(([t,e])=>{void 0!==e&&(l+=`, ${t} = ?`,d.push(e))}),l+=" WHERE consultation_id = ?",d.push(n);let c=await i.prepare(l).bind(...d).run();if(!c.success)throw Error(`Failed to update consultation: ${c.error}`);return new Response(JSON.stringify({message:"Consultation updated successfully"}),{status:200})}catch(t){return console.error(`Update consultation ${n} error:`,t),new Response(JSON.stringify({error:"Internal Server Error",details:t instanceof Error?t.message:"An unexpected error occurred"}),{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/consultations/[consultationId]/route",pathname:"/api/consultations/[consultationId]",filename:"route",bundlePath:"app/api/consultations/[consultationId]/route"},resolvedPagePath:"/workspace/Hospital-Management-System/src/app/api/consultations/[consultationId]/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:O,workUnitAsyncStorage:E,serverHooks:N}=w;function g(){return(0,i.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:E})}},77598:t=>{"use strict";t.exports=require("node:crypto")}};var e=require("../../../../webpack-runtime.js");e.C(t);var r=t=>e(e.s=t),n=e.X(0,[7395,2482,4388,1295],()=>r(74152));module.exports=n})();